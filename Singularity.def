Bootstrap: docker
From: nvidia/cuda:11.6.2-cudnn8-runtime-ubuntu20.04

%post
    apt-get -y update
    apt-get -y install g++ build-essential wget bzip2
    wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda.sh
    bash ~/miniconda.sh -b -p /opt/conda
    rm ~/miniconda.sh
    export PATH="/opt/conda/bin:$PATH"
    conda update -y -n base -c defaults conda
    conda config --add channels conda-forge
    conda env create -f /opt/environment.yml
    echo ". /opt/conda/etc/profile.d/conda.sh" >> ~/.bashrc
    echo "conda activate hpc" >> ~/.bashrc

%environment
    export PATH="/opt/conda/bin:$PATH"
    export PATH=/usr/local/nvidia/bin:/usr/local/cuda/bin:${PATH}
    export LD_LIBRARY_PATH=/usr/local/nvidia/lib:/usr/local/nvidia/lib64
    export NCCL_SOCKET_IFNAME='lo,docker,vethc'
    . /opt/conda/etc/profile.d/conda.sh
    conda activate hpc

%files
    /home/seventheli/research/Block_ExperienceReplay /local_scratch
    environment.yml /opt

%runscript
    . /opt/conda/etc/profile.d/conda.sh
    conda activate hpc
    cd /local_scratch

